name: decoder/rootcheck/0

sources:
  - decoder/queue-rootcheck/0

metadata:
    module: wazuh-agent/rootcheck/rootcheck
    title: Rootcheck Decoder
    description: >
        Decodes rootcheck events
    compatibility: >
        This decoder has been tested on Wazuh version 4.3.9
    author:
        name: Wazuh, Inc.
        email: info@wazuh.com
        url: https://wazuh.com
        date: 2022/11/08
    references:
        - https://documentation.wazuh.com/current/user-manual/capabilities/policy-monitoring/rootcheck/index.html
        - https://documentation.wazuh.com/current/user-manual/reference/ossec-conf/rootcheck.html

normalize:
  - map:
      - ~time: +sys_epoch
      - ~query: +s_concat/agent /$agent.id/ rootcheck save /$~time/ /$event.original
      - ~result: +wdb_query/$~query
      - wazuh.rootcheck.file: +r_ext/$event.original/(?:f|F)ile '(.*?)'
      - ~title: "+r_ext/$event.original/(.*?)(?:(?: {)|$)"

  - check:
      - ~result: "2"
    map:
      - wazuh.rootcheck.fts: true

  - check:
      - ~result: "1"
    map:
      - wazuh.rootcheck.update: true

  - check:
      - wazuh.rootcheck.file: +ef_not_exists
    map:
      - wazuh.rootcheck.file: "+r_ext/$event.original/File: (.*?)(?:(?:\\. )|(?:\\.$))"

  - map:
      - ~title: "+r_ext/$~title/System Audit: (.*? - .*)"

  - map:
      - ~title: "+r_ext/$~title/^(.*\\.) "

  - check:
      - ~title: "+r_match/(?:f|F)ile "
    map:
      - ~pre_file: "+r_ext/$~title/(.*?(?:f|F)ile) "
      - ~pos_file: "+r_ext/$~title/(?:f|F)ile '(?:.*?)'(.*)"
      - ~title: +s_concat/$~pre_file/$~pos_file

  - check:
      - ~title: "+r_match/.+"
    map:
      - wazuh.rootcheck.title: +ef_rename/$~title
